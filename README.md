# v2rayN 节点延迟历史记录管理指南

## 概述

本方案通过纯数据库操作实现节点延迟测试的历史记录管理，无需修改 v2rayN 源代码。通过记录多次测试结果，可以更准确地评估节点的稳定性和可用性。

## 文件说明

- `01_create_history_table.sql` - 创建历史记录表
- `02_save_test_results.sql` - 保存测试结果到历史记录
- `03_query_best_nodes.sql` - 查询优秀节点
- `04_cleanup_history.sql` - 清理历史记录表
- `05_export_best_nodes.sql` - 导出优秀节点（可导入到其他v2rayN实例）
- `export_best_nodes.py` - Python脚本：生成v2rayN URI格式
- `run_export.bat` - Windows批处理：运行Python脚本
- `README_export.md` - Python脚本使用说明

## 使用步骤

### 第一步：创建历史记录表

1. 打开 DBeaver，连接到 v2rayN 的数据库 `guiNDB.db`
2. 打开 `01_create_history_table.sql`
3. 执行脚本，创建 `ProfileExItemHistory` 表

**表结构说明：**
- `Id` - 主键，自增
- `IndexId` - 节点ID，对应 ProfileItem.IndexId
- `Delay` - 延迟值（毫秒），0表示测试失败
- `TestTime` - 测试时间，格式为 'YYYY-MM-DD HH:MM:SS'
- `Success` - 是否成功，1=成功（Delay>0），0=失败（Delay=0）

### 第二步：在 v2rayN 中测试节点

1. 打开 v2rayN
2. 进入节点列表
3. 选择要测试的节点（可以全选）
4. 右键点击，选择"测试真连接延迟"
5. 等待测试完成

### 第三步：保存测试结果到历史记录

1. 在 DBeaver 中打开 `02_save_test_results.sql`
2. 选择适合的保存方式（默认使用方式1）
3. 执行脚本

**注意：**
- 脚本使用 `datetime('now', 'localtime')` 自动获取当前时间，无需手动替换
- 时间格式为：`YYYY-MM-DD HH:MM:SS`

**建议：**
- 每次测试后都保存一次，建立完整的历史记录
- 可以在不同时间段测试（如上午、下午、晚上），观察节点在不同时间的表现
- 建议至少测试3-5次，才能得到可靠的统计数据

### 第四步：查询优秀节点

1. 在 DBeaver 中打开 `03_query_best_nodes.sql`
2. 根据需求选择合适的查询：
   - **查询1**：查看所有节点的基础统计信息
   - **查询2**：综合评分排序（推荐）
   - **查询3**：按成功率排序
   - **查询4**：低延迟节点（< 200ms）
   - **查询5**：稳定节点（成功率 >= 80%）
   - **查询6**：查看指定节点的详细历史记录
   - **查询7**：最近测试的节点
3. 执行选中的查询
4. 将查询结果中的 `IndexId` 或 `NodeName` 复制

### 第五步：在 v2rayN 中使用优秀节点

1. 在 v2rayN 节点列表中，使用搜索功能
2. 搜索刚才复制的 `IndexId` 或 `NodeName`
3. 选择综合评分高、延迟低、稳定性好的节点
4. 右键点击，选择"设为活动服务器"

### 第六步：导出优秀节点到其他 v2rayN 实例

如果你想把优秀节点分享给其他v2rayN实例使用：

1. 在 DBeaver 中打开 `05_export_best_nodes.sql`
2. 根据需求选择合适的导出方式：
   - **导出1**：导出节点列表（包含IndexId和备注）
   - **导出2**：导出节点配置信息（JSON格式）
   - **导出3**：导出节点统计信息（文本格式）
   - **导出4**：导出IndexId列表（用于批量搜索）
   - **导出5**：导出CSV格式（可直接用Excel打开）
3. 执行选中的导出查询
4. **推荐方式：通过IndexId搜索并分享**
   - 使用导出1获取优秀节点的IndexId列表
   - 在源v2rayN中，使用搜索功能搜索IndexId
   - 找到节点后，右键点击选择"分享"
   - 选择"分享为URL"或"分享为Base64"
   - 复制生成的URI链接
   - 在目标v2rayN中，选择"从剪贴板导入"

**注意：**
- SQLite无法直接生成v2rayN的URI格式（需要Base64编码等复杂操作）
- **推荐使用 `export_best_nodes.py` Python脚本**，可以直接生成v2rayN URI格式
- 也可以通过IndexId在v2rayN中搜索节点，然后使用v2rayN的分享功能
- 导出的CSV文件可以用于长期跟踪和分析节点性能

## 综合评分说明

查询2中的综合评分算法：

```
综合评分 = 成功率 * 60 + (1 - 标准化延迟) * 40 - 延迟波动惩罚

其中：
- 成功率权重：60%
- 延迟权重：40%
- 延迟波动惩罚：根据方差计算，波动越大惩罚越多
```

**评分解读：**
- 90-100分：优秀节点，延迟低且稳定
- 70-89分：良好节点，大部分时间可用
- 50-69分：一般节点，有一定可用性
- 0-49分：不推荐使用

## 实际使用场景

### 场景1：首次测试

1. 执行第一步：创建历史记录表
2. 执行第二步：测试所有节点
3. 执行第三步：保存测试结果
4. 执行第四步：查询优秀节点（使用查询1查看基础信息）
5. 执行第五步：选择前3-5个节点使用

### 场景2：定期测试（推荐）

**建议测试频率：**
- 每天1-2次（不同时间段）
- 连续测试3-5天

**操作步骤：**
1. 每次测试后执行第三步保存结果
2. 积累至少10-20条测试记录后，使用查询2查询综合评分
3. 选择评分最高的节点作为主要使用节点
4. 保留2-3个备用节点（评分次高的）

### 场景3：导出优秀节点到其他v2rayN实例

如果你想把优秀节点分享给其他v2rayN实例使用：

**操作步骤：**
1. 执行第六步：使用 `05_export_best_nodes.sql` 导出优秀节点
2. 使用导出1获取优秀节点的IndexId列表
3. 在源v2rayN中，使用搜索功能搜索IndexId
4. 找到节点后，右键点击选择"分享"
5. 选择"分享为URL"或"分享为Base64"
6. 复制生成的URI链接
7. 在目标v2rayN中，选择"从剪贴板导入"

**批量导出：**
1. 使用导出5导出CSV格式
2. 在DBeaver中右键点击结果集，选择"导出结果集"
3. 选择CSV格式并保存
4. 用Excel打开CSV文件，查看节点信息
5. 根据IndexId在v2rayN中批量搜索节点

### 场景4：节点性能下降

如果发现当前使用的节点变慢或不可用：

1. 重新测试所有节点
2. 保存测试结果
3. 使用查询2查询最新综合评分
4. 切换到评分更高的节点

### 场景5：清理历史记录

当节点从订阅中删除或历史记录过多时，需要清理历史记录：

**清理时机：**
- 订阅更新后（删除不存在的节点历史记录）
- 历史记录过多时（限制每个节点的记录数量）
- 定期维护（删除旧记录）

**操作步骤：**
1. 在 DBeaver 中打开 `04_cleanup_history.sql`
2. 先执行查询语句，查看当前历史记录的统计信息
3. 根据需要选择合适的清理方式：
   - **清理1**：删除不存在于 ProfileItem 中的节点历史记录（推荐订阅更新后执行）
   - **清理2**：删除指定时间之前的旧记录
   - **清理3**：限制每个节点保留最近N条记录
   - **清理4**：删除测试失败的记录
   - **清理5**：删除测试次数过少的节点历史记录
   - **清理6**：删除重复的测试记录
   - **清理7**：组合清理（推荐定期执行）
4. 取消注释（删除 `--`）要执行的清理语句
5. 执行清理语句
6. 再次执行查询语句，确认清理结果

**推荐清理策略：**
- 每次订阅更新后，执行清理1（删除不存在的节点）
- 每周执行一次清理7（组合清理）
- 根据实际需求调整保留天数和记录数量

## 注意事项

1. **时间格式**：SQLite 中时间字符串必须使用单引号，格式为 `YYYY-MM-DD HH:MM:SS`
2. **数据备份**：在执行删除操作前，建议备份数据库文件
3. **测试环境**：尽量在网络环境稳定时测试，避免网络波动影响结果
4. **测试间隔**：建议每次测试间隔至少10分钟，避免短时间内重复测试
5. **节点更新**：如果订阅更新导致节点变化，历史记录中不存在的节点不会影响查询结果

## 常见问题

**Q: 为什么有些节点测试结果为0？**
A: 测试结果为0表示节点无法连接或测试超时。这些节点在统计中会被标记为失败。

**Q: 综合评分和成功率有什么区别？**
A: 成功率只考虑连接成功的比例，而综合评分同时考虑了延迟和延迟波动，更能反映节点的实际使用体验。

**Q: 历史记录会占用很多空间吗？**
A: 每条记录约50-100字节，100个节点测试100次约1MB，影响不大。可以使用 `04_cleanup_history.sql` 定期清理。

**Q: 如何判断一个节点是否稳定？**
A: 查看查询1中的 `SuccessRate`（成功率）和 `MaxDelay`（最大延迟）。成功率 >= 80% 且最大延迟不超过平均延迟的2倍，可以认为是稳定节点。

**Q: 能否直接用SQL生成v2rayN的URI格式？**
A: 不能。v2rayN的URI格式需要复杂的Base64编码和加密操作，SQLite无法直接完成。建议通过IndexId在v2rayN中搜索节点，然后使用v2rayN的"分享"功能生成URI。

**Q: 如何把优秀节点导出到其他v2rayN实例？**
A: 使用 `05_export_best_nodes.sql` 脚本：
1. 执行导出1获取优秀节点的IndexId列表
2. 在源v2rayN中搜索IndexId
3. 右键点击节点，选择"分享" → "分享为URL"或"分享为Base64"
4. 复制生成的URI链接
5. 在目标v2rayN中，选择"从剪贴板导入"

## 进阶使用

### 自定义查询

你可以基于提供的查询模板，自定义查询条件：

```sql
-- 例如：查询成功率 >= 70% 且平均延迟 < 300ms 的节点
SELECT
    h.IndexId,
    pi.Remarks AS NodeName,
    COUNT(*) AS TotalTests,
    ROUND(SUM(CASE WHEN h.Success = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS SuccessRate,
    ROUND(AVG(CASE WHEN h.Success = 1 THEN h.Delay ELSE NULL END), 0) AS AvgDelay
FROM ProfileExItemHistory h
INNER JOIN ProfileItem pi ON h.IndexId = pi.IndexId
GROUP BY h.IndexId, pi.Remarks
HAVING COUNT(*) >= 3
  AND SUM(CASE WHEN h.Success = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) >= 70
  AND AVG(CASE WHEN h.Success = 1 THEN h.Delay ELSE NULL END) < 300
ORDER BY SuccessRate DESC, AvgDelay ASC;
```

## 总结

通过这套SQL脚本，你可以：

1. ✅ 记录节点延迟测试历史
1. ✅ 分析节点稳定性和可用性
1. ✅ 找到最适合使用的节点
1. ✅ 清理无效的历史记录
1. ✅ 不修改 v2rayN 源代码

建议定期测试并保存结果，积累足够的历史数据后，查询结果会更加准确可靠！
